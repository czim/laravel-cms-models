# Model Configuration: Form Validation

## Configuration

Validation rules are defined in the `form.validation` model configuration section.


### Create & Update Rules

Separate validation rules are defined for creating and updating records. 
These rules may share common defaults, but can also be further defined for create and/or update only. 

When setting rules manually that should similarly affect both forms, set them in the `shared` section.
As long as the `create` and `update` section are left empty, they will use these shared rules.

To set rules that will *only* be used when creating or updating records, define them in the `create` and `update` 
sections, respectively.


Example:
```php
<?php
return [
    // ...
    
    'form' => [
        // ...
        
        'validation' => [
            
            'shared' => [
                'name'    => 'min:6',
                'checked' => 'boolean',
            ],
            
            'create' => [
                // These rules will only apply while creating new records.
                // The 'name' rule will override the shared rule, so it would NOT
                // require min:6 in this case.
                'name'        => 'required|string',
                'description' => [ 'string', 'max:512' ],
            ],
            
            // Since no update rules are defined, only the shared rules will apply 
            'update' => [],
        ]
    ]
];
```

For the above example, the following rules would be used:

- Creating records:
    - `name`: `required|string`
    - `checked`: `boolean`
    - `description`: `string|max:512`
- Updating records:
    - `name`: `min:6`
    - `checked`: `boolean`


### Overriding Individual Rules

Regardless of whether rules are replaced or enriched, any rule configured with a value of `false` or `null` will be disabled.
No default rules for that field key (or specific rule key) will be included in the final ruleset.

This will work regardless of whether the relevant rule section is overriding or enriching (see below).


### Overriding vs. Enriching Rules Per Section

By default, any configured rules for `shared`, `create` and `update` sections will replace all default rules
*for that form field*, but leave unaffected all *other* form field validation rules generated by the CMS.

It is possible to change this behaviour using the `form.validation.create_replace` and `form.validation.update_replace` keys. 
Set them to `true` to let the `create` and `update` sections respectively completely replace any default CMS rules.

If this is used, any key not present in the relevant rule section will *not* have validation rules at all.

Example:
```php
<?php
return [
    // ...
    
    'form' => [
        // ...
        
        'validation' => [
        
            // Put the update rule section in 'replace' mode. 
            'update_replace' => true,
            
            // Now the *only* validation rule for the update form 
            // will be for the 'name' form field.
            'update' => [
                'name' => 'required|string',
            ]
            
            // The create rules are unaffected by this.
        ]
    ]
];
```

### Using a Custom Class to Determine Validation Rules

If the possibilities of configuration are insufficient, a decorator class may be indicated using the `rules_class` key:
 
```php
<?php
return [
    // ...
    
    'form' => [
        // ...
        
        'validation' => [
        
            'rules_class' => App\Your\DecoratorClass::class,
        ]
    ]
];
```

This class must implement `Czim\CmsModels\Contracts\Http\Requests\ValidationRulesInterface`, 
[which has a `create` and an `update` method](https://github.com/czim/laravel-cms-models/blob/master/src/Contracts/Http/Requests/ValidationRulesInterface.php). 

The validation rules configured for the model will be passed into these methods and may be altered or ignored entirely.
The arrays returned by these methods will then be used to validate the submitted form data.


## Examples

This is a list of example configurations with a list of the validation rules that would by result
apply for create and update operations.


### Using The Same Rules For Create And Update

```php
<?php
return [
    'form' => [
        'validation' => [
        
            'shared' => [
                'name' => 'required|string',
                'slug' => ['string', 'regex:#^[a-z_/]{3,4}$#i'], 
            ],
            
            // As long as these sections are empty, the shared rules will be used.
            'create' => null,
            'update' => [],
        ]
    ]
];
```

The following rules would apply:

- Creating records:
    - `name`: `required|string`
    - `slug`: `[string, regex:#^[a-z_/]{3,4}$#i]`
- Updating records:
    - `name`: `required|string`
    - `slug`: `[string, regex:#^[a-z_/]{3,4}$#i]`


### Using Additional Specific Rules Only For Creating A Model

```php
<?php
return [
    'form' => [
        'validation' => [
        
            'shared' => [
                'name' => 'required|string',
                'slug' => ['string', 'min:10'], 
            ],
            
            'create' => [
                'body' => 'required|string|min:50',
            ],
            
            'update' => [],
        ]
    ]
];
```

The following rules would apply:

- Creating records:
    - `name`: `required|string`
    - `slug`: `string|min:10`
    - `body`: `required|string|min:50`
- Updating records:
    - `name`: `required|string`
    - `slug`: `string|min:10`


### Disabling Specific Shared or CMS Default Rules Only For Creating A Model

Given a setup with Form Field Strategy for a field `image` that sets the following rules:

- `image.keep`: `in:1,0`
- `image.file`: `required_if|image.keep,1`

And the following configuration:

```php
<?php
return [
    'form' => [
        'validation' => [
        
            'shared' => [
                'name' => 'required|string',
                'slug' => ['string', 'min:10'], 
            ],
            
            'create' => [
                'name' => null,
                'image.keep' => null,
            ],
            
            'update' => [],
        ]
    ]
];
```

The following rules would apply:

- Creating records:
    - `name`: `required|string`
    - `slug`: `string|min:10`
    - `image.file`: `required_if|image.keep,1`
- Updating records:
    - `slug`: `string|min:10`
    - `image.keep`: `in:1,0`
    - `image.file`: `required_if|image.keep,1`


### Replacing Rules For Creating, Not Using CMS Defaults At All

Given a setup with Form Field Strategy for a field `image` that sets the following rules:

- `image.keep`: `in:1,0`
- `image.file`: `required_if|image.keep,1`

And the following configuration:

```php
<?php
return [
    'form' => [
        'validation' => [
        
            'shared' => [],
            
            // This flag makes the create section ignore any CMS defaults
            'create_replace' => true,
            
            'create' => [
                'name' => 'required|string',
            ],
            
            'update' => [],
        ]
    ]
];
```

The following rules would apply:

- Creating records:
    - `name`: `required|string`
- Updating records:
    - `image.keep`: `in:1,0`
    - `image.file`: `required_if|image.keep,1`


### Using a Decorator Class to Provide Validation Rules

Given this custom decorator class:

```php
<?php
namespace App\Cms\Validation;

class CustomRules implements \Czim\CmsModels\Contracts\Http\Requests\ValidationRulesInterface
{
    public function create(array $rules)
    {
        return [
            'name' => 'required|string',
            'type' => 'in:main,secondary,custom', 
        ];
    }
    
    public function update(array $rules, \Illuminate\Database\Eloquent\Model $model = null)
    {
        return array_merge($rules, [
            'email' => \Illuminate\Validation\Rule::unique('records')
                ->ignore($model->email, 'email')
        ]);
    }
}
```

```php
<?php
return [
    'form' => [
        'validation' => [
            
            'shared' => [
                'checked' => 'boolean',                
            ],
            
            'rules_class' => App\Cms\Validation\CustomRules::class,
        ]
    ]
];
```

The following rules would apply:

- Creating records:
    - `name`: `required|string`
    - `type`: `in:main,secondary,custom`
- Updating records:
    - `checked`: `boolean`
    - `email`: `unique,records,email,{updated model's email}`
